# Лабораторная работа №7

- [Лабораторная работа №7](#лабораторная-работа-7)
  - [Задания](#задания)
    - [Требования](#требования)
    - [Задание 1: подготовка образа реального Flash-накопителя в ОС Linux — 50 баллов](#задание-1-подготовка-образа-реального-flash-накопителя-в-ос-linux--50-баллов)
      - [Цели](#цели)
      - [Шаг 1. Подключить флешку и определить устройство - 50 баллов](#шаг-1-подключить-флешку-и-определить-устройство---50-баллов)
      - [Шаг 2. Создать точку монтирования и смонтировать флешку](#шаг-2-создать-точку-монтирования-и-смонтировать-флешку)
      - [Шаг 3. Размонтировать флешку перед созданием образа](#шаг-3-размонтировать-флешку-перед-созданием-образа)
      - [Шаг 4. Создать файл-образ флешки](#шаг-4-создать-файл-образ-флешки)
      - [Шаг 5. Проверить размер и побайтную точность](#шаг-5-проверить-размер-и-побайтную-точность)
      - [Шаг 6. Смонтировать созданный образ](#шаг-6-смонтировать-созданный-образ)
      - [Шаг 7. Размонтировать образ](#шаг-7-размонтировать-образ)
      - [Дополнительные упражнения](#дополнительные-упражнения)
        - [Упражнение А: посмотреть «сырые» данные образа](#упражнение-а-посмотреть-сырые-данные-образа)
        - [Упражнение Б: проверить первую запись FAT](#упражнение-б-проверить-первую-запись-fat)
        - [Упражнение В: попробовать открыть образ как блочное устройство](#упражнение-в-попробовать-открыть-образ-как-блочное-устройство)
    - [Задание 2: Вывод содержимого файла или каталога из образа Flash-накопителя — 150 баллов](#задание-2-вывод-содержимого-файла-или-каталога-из-образа-flash-накопителя--150-баллов)
      - [1. Цель задания](#1-цель-задания)
      - [2. Описание задачи](#2-описание-задачи)
        - [Если путь указывает на каталог](#если-путь-указывает-на-каталог)
        - [Если путь указывает на файл:](#если-путь-указывает-на-файл)
        - [Если путь некорректен:](#если-путь-некорректен)
      - [3. Требования к реализации](#3-требования-к-реализации)
        - [3.1. Чтение каталогов](#31-чтение-каталогов)
        - [3.2. Работа с FAT](#32-работа-с-fat)
        - [3.3. Разбор пути](#33-разбор-пути)
        - [3.4. Набор ошибок для обработки](#34-набор-ошибок-для-обработки)
      - [4. Пример запуска](#4-пример-запуска)
      - [5. Дополнительные замечания](#5-дополнительные-замечания)
      - [6. Критерии оценки](#6-критерии-оценки)
  - [Приложение А. Особенности создания образа флеш-накопителя под Windows + WSL2](#приложение-а-особенности-создания-образа-флеш-накопителя-под-windows--wsl2)
    - [А1. Определение номера физического устройства флешки](#а1-определение-номера-физического-устройства-флешки)
    - [А2. Создание файла-образа флешки в Windows](#а2-создание-файла-образа-флешки-в-windows)
    - [А3. Копирование файла-образа в WSL](#а3-копирование-файла-образа-в-wsl)
    - [А4. Использование файла-образа внутри WSL2](#а4-использование-файла-образа-внутри-wsl2)
      - [Просмотр первых 512 байт (Boot Sector):](#просмотр-первых-512-байт-boot-sector)
      - [Создание loop-устройства:](#создание-loop-устройства)
      - [Монтирование образа (если требуется посмотреть содержимое):](#монтирование-образа-если-требуется-посмотреть-содержимое)
    - [А5. Почему нельзя работать напрямую с флешкой в WSL2](#а5-почему-нельзя-работать-напрямую-с-флешкой-в-wsl2)
    - [А6. Примечание об экспериментальной поддержке USB (не использовать в учебной работе)](#а6-примечание-об-экспериментальной-поддержке-usb-не-использовать-в-учебной-работе)
    - [А7. Результат](#а7-результат)

## Задания

- Для получения оценки "удовлетворительно" нужно набрать не менее X баллов.
- Для получения оценки "хорошо" нужно набрать не менее Y баллов.
- Для получения оценки "отлично" нужно набрать не менее Z баллов.

### Требования

Обязательно проверяйте успешность всех вызовов функций операционной системы и не оставляйте ошибки незамеченными.

Ваш код должен иметь уровень безопасности исключений не ниже базового.
Для этого разработайте (или возьмите готовую) RAII-обёртку, автоматизирующую
управление ресурсами операционной системы.

### Задание 1: подготовка образа реального Flash-накопителя в ОС Linux — 50 баллов

#### Цели

1. Узнать, что такое блочные устройства `/dev/sdX`.
2. Научиться определять, какая флешка является его устройством.
3. Научиться монтировать и размонтировать USB-накопитель.
4. Создать точный образ (байт-в-байт) своей флешки.
5. Убедиться, что образ и флешка содержат одинаковые данные.

Это создаёт фундамент для дальнейших лабораторных работ.

#### Шаг 1. Подключить флешку и определить устройство - 50 баллов

Если вы используете WSL 

Выполните команду:

```bash
lsblk
```

Будет выведено что-то вроде:

```txt
sdb      8:16   1  4G  0 disk
└─sdb1   8:17   1  4G  0 part
```

**Контрольная точка:** вы должы осознанно определить, что `sdb` (или `sdc`) — ваша флешка.
Не перепутайте её с системным диском `sda`.

#### Шаг 2. Создать точку монтирования и смонтировать флешку

```bash
mkdir ~/flash
sudo mount /dev/sdb1 ~/flash
ls ~/flash          # убедиться, что всё видно
```

#### Шаг 3. Размонтировать флешку перед созданием образа

```bash
sudo umount /dev/sdb1
```

Важно: **образ нужно снимать только с размонтированного устройства**,
иначе ОС может кешировать данные и результат будет некорректный.

#### Шаг 4. Создать файл-образ флешки

```bash
sudo dd if=/dev/sdb of=fat32.img bs=16M status=progress
```

Примечание: `if` — input file (источник), `of` — output file (образ).
Используйте `status=progress`, чтобы видеть процесс;

#### Шаг 5. Проверить размер и побайтную точность

```bash
ls -lh fat32.img
```

Размер должен совпадать с размером флешки.

Можете проверить хеши:

```bash
sudo dd if=/dev/sdb | sha256sum
sha256sum fat32.img
```

Хеши должны совпасть. Не монтируйте флешку между снятием образа и проверкой хеша,
чтобы избежать записей на диск со стороны других программ.

#### Шаг 6. Смонтировать созданный образ

```bash
mkdir ~/flash_img
sudo losetup -fP fat32.img # Создает /dev/loop0 и /dev/loop0p1
sudo mount /dev/loop0p1 ~/flash_img 
ls ~/flash_img
```

Поскольку образ fat32.img является копией всего диска (включая таблицу разделов), команда sudo mount fat32.img -o loop не сработает, так как файловая система FAT32 начинается не с нулевого байта. Необходимо либо:

- Указать конкретный раздел (/dev/sdb) после сканирования через losetup -P (как показано выше).

- Указать смещение начала раздела, например: sudo mount fat32.img ~/flash_img -o loop,offset=1048576.

Убедитесь, что содержимое идентично исходной флешке.

#### Шаг 7. Размонтировать образ

```bash
sudo umount ~/flash_img
```

#### Дополнительные упражнения

Может быть опционально, но сильно развивает понимание:

##### Упражнение А: посмотреть «сырые» данные образа

```bash
hexdump -C fat32.img | head
```

Должны увидеть Boot Sector с подписью `FAT32`.

##### Упражнение Б: проверить первую запись FAT

```bash
dd if=fat32.img bs=512 skip=0 count=1 | hexdump -C
```

##### Упражнение В: попробовать открыть образ как блочное устройство

```bash
sudo losetup --find --show fat32.img
```

Обычно это даёт `/dev/loop0`.

Проверить:

```bash
lsblk
```

Теперь образ выглядит *как настоящая флешка*.

### Задание 2: Вывод содержимого файла или каталога из образа Flash-накопителя — 150 баллов

В этом задании необходимо разработать консольное приложение,
которое позволяет просматривать структуру файловой системы FAT32,
находящейся внутри файла-образа флешки.

Приложение должно уметь работать как с каталогами, так и с файлами,
поддерживать длинные имена (LFN) и корректно обрабатывать ошибки.

#### 1. Цель задания

Научиться:

- читать и анализировать структуры FAT32 на низком уровне;
- работать с Boot Sector, FAT-таблицами и записями каталогов;
- реализовать поиск каталога/файла по заданному пути;
- выводить содержимое каталогов и файлов в текстовом виде;
- корректно обрабатывать длинные имена файлов (LFN);
- работать с блочным образом как с обычным файлом.

#### 2. Описание задачи

Требуется реализовать программу:

```bash
show-file <путь_к_образу> <путь_внутри_FAT32>
```

Программа получает два аргумента:

1. Путь к файлу-образу FAT32 (например, `~/flash.img`)
2. Путь к файлу или каталогу внутри файловой системы FAT32
   (например, `/downloads/videos`, `/.`, `/file.txt`)

Программа должна:

1. Открыть образ FAT32 как обычный файл (`open`, `pread`, `lseek`).
2. Прочитать Boot Sector и определить:
   - размер сектора,
   - число секторов в кластере,
   - параметры FAT-таблиц,
   - номер первого кластера корневого каталога.
3. Разрешить путь, проходя каталог за каталогом (path resolution).
4. Найти запись каталога или файла, соответствующую указанному пути.
5. В зависимости от результата:

##### Если путь указывает на каталог

Необходимо вывести содержимое каталога построчно:

```txt
D .
D ..
D videos1
F video1.mp4 12345678
```

Где:

- `D` — директория,
- `F` — обычный файл,
- `.` и `..` должны быть добавлены программой;
- после имени файла выводится его размер (в байтах).

##### Если путь указывает на файл:

Программа должна вывести:

- строку `"FILE <имя> <размер_в_байтах>"`,
- затем *сырое содержимое файла*.

##### Если путь некорректен:

- каталог отсутствует,
- файл отсутствует,
- path resolution не дал результата,
- формат записей повреждён,

то программа должна вывести человекочитаемое сообщение об ошибке. Например:

```txt
Error: path not found.
Error: not a directory.
Error: invalid FAT32 structure.
```

#### 3. Требования к реализации

##### 3.1. Чтение каталогов

Записи каталога FAT32 состоят из:

- коротких записей (8.3),
- длинных имён (LFN), состоящих из цепочки специальных direntry.

Программа должна:

- корректно собирать длинные имена из LFN-записей;
- игнорировать “deleted” записи;
- учитывать признаки каталога/файла;
- обрабатывать цепочку кластеров каталога через FAT.

##### 3.2. Работа с FAT

Необходимо реализовать:

- чтение FAT по номеру кластера,
- определение конца цепочки (значения `0x0FFFFFF8`…`0x0FFFFFFF`),
- переход по FAT-цепочке для чтения каталогов и файлов.

##### 3.3. Разбор пути

Путь вида:

```txt
/downloads/videos
```

должен быть разбит на сегменты:

```txt
downloads
videos
```

Алгоритм:

1. Начинаем с корневого каталога.
2. Находим запись `"downloads"`.
3. Проверяем, что это каталог.
4. Переходим в него, читаем его содержимое.
5. Находим `"videos"`.
6. В зависимости от типа — выводим каталог или файл.

##### 3.4. Набор ошибок для обработки

- файл отсутствует
- каталог отсутствует
- путь ведёт в файл, но программа ожидала каталог
- повреждённая FAT-цепочка
- невозможность прочитать сектор
- указанный образ не является FAT32

Программа не должна аварийно завершаться.

#### 4. Пример запуска

```bash
show-file /home/user/fat32.img /downloads/videos
```

Ожидаемый вывод (пример):

```txt
D .
D ..
D videos1
F video1.mp4 12345678
```

#### 5. Дополнительные замечания

- В выводе не нужно сортировать имена — порядок такой же, как на диске.
- Можно ограничиться поддержкой только атрибутов **каталог** и **файл**.
- Допускается сдача без поддержки LFN обязателен с коэффициентом 0.8
- Образ может быть большим — используйте `pread`, а не `read`.
- Нельзя полагаться на выравнивание структур — используйте `#pragma pack` и его аналоги или ручной `memcpy`.

#### 6. Критерии оценки

1. Корректный разбор Boot Sector и параметров FAT32.
2. Успешный поиск указанного пути.
3. Корректная обработка LFN.
4. Верное определение типа записей (файл/каталог).
5. Чтение FAT-цепочек без ошибок.
6. Работа с ошибками и диагностика.
7. Структурированность кода и отсутствие UB при работе с бинарными структурами.

## Приложение А. Особенности создания образа флеш-накопителя под Windows + WSL2

При работе в среде Windows с установленным WSL2 следует учитывать важную особенность:
WSL2 не предоставляет прямого доступа к USB-устройствам как к блочным устройствам Linux.

Это означает, что подключённая USB-флешка **не появится** в WSL как `/dev/sdb`, `/dev/sdc` и т.п.,
и её невозможно прочитать с помощью инструментов Linux (`dd`, `hexdump`, `lsblk`).

Для выполнения лабораторной работы вы должны **создать образ флешки под Windows**,
а затем использовать этот образ (обычный файл `.img`) внутри WSL аналогично блочному устройству.

Далее приведена инструкция по такому сценарию.

### А1. Определение номера физического устройства флешки

Откройте PowerShell от имени администратора и выполните:

```powershell
Get-Disk
```

В выводе найдите свою флешку. Как правило, она отображается как устройство небольшого размера (8–64 ГБ) с интерфейсом USB.

Пример:

```txt
Number Friendly Name         Size
------ --------------------- -------
0      NVMe SSD              953 GB
1      HDD                   1.8 TB
2      Generic Flash Disk     29 GB   ← флешка
```

Запомните номер диска (например, 2).

### А2. Создание файла-образа флешки в Windows

PowerShell не поддерживает Linux-синтаксис `dd`, поэтому важно корректно вызвать программу с аргументами.

Если у вас установлен Git for Windows, используйте следующую команду:

```powershell
& "C:\Program Files\Git\usr\bin\dd.exe" if=\\.\PhysicalDriveN of=C:\Users\<имя_пользователя>\flash.img bs=16M
```

где

- **N** — номер диска из вывода `Get-Disk`,
- **flash.img** — имя создаваемого файла-образа.

Пример:

```powershell
& "C:\Program Files\Git\usr\bin\dd.exe" if=\\.\PhysicalDrive2 of=C:\Users\<имя пользователя>\flash.img bs=16M
```

> Примечание. Версия `dd`, поставляемая с Git for Windows, **не поддерживает отображение прогресса**.
> Команда выполнится «тихо». Это нормально.

После завершения убедитесь, что файл появился:

```powershell
dir C:\Users\malov\flash.img
```

Размер файла будет равен полной ёмкости флешки.

---

### А3. Копирование файла-образа в WSL

Внутри Ubuntu/WSL выполните:

```bash
cp /mnt/c/Users/<имя_пользователя>/flash.img ~/
ls -lh ~/flash.img
```

Теперь `flash.img` находится в домашнем каталоге WSL и доступен как обычный файл Linux.

---

### А4. Использование файла-образа внутри WSL2

Далее образ можно использовать **точно так же**, как если бы он был реальным блочным устройством:

#### Просмотр первых 512 байт (Boot Sector):

```bash
dd if=flash.img bs=512 count=1 | hexdump -C
```

#### Создание loop-устройства:

```bash
sudo losetup -fP flash.img
sudo losetup -a
```

Обычно система назначает `/dev/loop0`.

#### Монтирование образа (если требуется посмотреть содержимое):

```bash
sudo mount flash.img /mnt -o loop
ls /mnt
sudo umount /mnt
```

Все последующие задания лабораторной выполняются с файлом `flash.img`, считая его «флешкой».

---

### А5. Почему нельзя работать напрямую с флешкой в WSL2

WSL2 использует виртуализированное Linux-ядро и изолированную файловую систему.
Windows **не передаёт USB-устройства напрямую в виртуальную машину WSL**, поэтому:

- флешка **не появляется** как `/dev/sdX`,
- `lsblk` не показывает её,
- невозможно выполнить `dd if=/dev/sdb`,
- невозможно получить сырые сектора.

Именно поэтому создание образа выполняется на стороне Windows, а анализ — в WSL.

---

### А6. Примечание об экспериментальной поддержке USB (не использовать в учебной работе)

В Windows 11 есть экспериментальная возможность подключать USB-устройства к WSL
через утилиту [usbipd](https://learn.microsoft.com/en-us/windows/wsl/connect-usb):

```bat
usbipd wsl attach
```

Однако:

- поддерживаются не все флешки,
- возникают ошибки передачи данных,
- данные могут быть повреждены,
- требуется запуск от администратора.

**Для учебной лабораторной работы данный метод не рекомендуется.**

---

### А7. Результат

После выполнения шагов А1–А4 вы получите:

- файл `flash.img` — байт-в-байт копию своей флешки;
- возможность работать с ним в WSL как с блочным устройством;
- полностью воспроизводимую, безопасную и независимую среду для анализа FAT32.

