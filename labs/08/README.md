# Лабораторная работа №8

- [Лабораторная работа №8](#лабораторная-работа-8)
  - [Критерии оценивания](#критерии-оценивания)
    - [Требования](#требования)
  - [Частые ошибки](#частые-ошибки)
    - [Общие ошибки (для всех заданий)](#общие-ошибки-для-всех-заданий)
  - [Задания](#задания)
    - [Задание 1 — Калькулятор — 50 баллов](#задание-1--калькулятор--50-баллов)
      - [Требования](#требования-1)
      - [Подсказки](#подсказки)
      - [Частые ошибки](#частые-ошибки-1)
    - [Задание 2 — Доска для рисования — 150 баллов](#задание-2--доска-для-рисования--150-баллов)
      - [Подсказки](#подсказки-1)
      - [Бонус за возможность клиентов также управлять рисованием — 50 баллов](#бонус-за-возможность-клиентов-также-управлять-рисованием--50-баллов)
      - [Бонус за возможность смены цвета рисования — 20 баллов](#бонус-за-возможность-смены-цвета-рисования--20-баллов)
      - [Частые ошибки](#частые-ошибки-2)
    - [Задание №3 — Поисковая система — 200 баллов](#задание-3--поисковая-система--200-баллов)
      - [Сохранение документов в постоянное хранилище — 50 баллов](#сохранение-документов-в-постоянное-хранилище--50-баллов)
      - [Бонус за автоматическое наполнение поисковой системы —80 баллов](#бонус-за-автоматическое-наполнение-поисковой-системы-80-баллов)
      - [Бонус за поддержку постраничной выдачи результатов — 20 баллов](#бонус-за-поддержку-постраничной-выдачи-результатов--20-баллов)
      - [Бонус за вывод фрагмента документа, содержащего искомые слова — 50 баллов](#бонус-за-вывод-фрагмента-документа-содержащего-искомые-слова--50-баллов)
      - [Бонус за возможность выполнить graceful shutdown  — 10 баллов](#бонус-за-возможность-выполнить-graceful-shutdown---10-баллов)
      - [Частые ошибки](#частые-ошибки-3)

## Критерии оценивания

- Для получения оценки "удовлетворительно" нужно набрать не менее 120 баллов.
- Для получения оценки "хорошо" нужно набрать не менее 200 баллов.
- Для получения оценки "отлично" нужно набрать не менее 300 баллов.

### Требования

Обязательно проверяйте успешность всех вызовов функций операционной системы и не оставляйте ошибки незамеченными.

Ваш код должен иметь уровень безопасности исключений не ниже базового.
Для этого разработайте (или возьмите готовую) RAII-обёртку, автоматизирующую
управление ресурсами операционной системы.

## Частые ошибки

Ниже перечислены наиболее распространённые ошибки, допускаемые при выполнении лабораторной работы.
Рекомендуется ознакомиться с этим разделом **до начала реализации**.

### Общие ошибки (для всех заданий)

- **Игнорирование ошибок системных вызовов.**
  Все функции операционной системы и библиотеки Boost возвращают коды ошибок или генерируют исключения.
  Игнорирование ошибок может приводить к неопределённому поведению и потере баллов.
- **Отсутствие RAII для ресурсов.**
  Открытые сокеты, файловые дескрипторы, потоки или другие ресурсы должны
  автоматически освобождаться при выходе из области видимости,
  включая случаи возникновения исключений.
- **Непонимание требований по exception safety.**
  Код должен обеспечивать базовую гарантию безопасности исключений:
  при возникновении исключения ресурсы не должны утекать,
  а объекты должны оставаться в корректном состоянии.
- **Использование глобальных переменных без синхронизации.**
  В многопоточных и сетевых приложениях доступ к общим данным должен быть защищён от состояний гонки.

## Задания

### Задание 1 — Калькулятор — 50 баллов

Напишите консольное приложение-калькулятор (либо для Linux, либо для Windows),
способное работать как в режиме клиента, так и в режиме сервера.
Обмен данными между клиентом и сервером должен осуществляться с использованием
функций для работы с сокетами для вашей операционной системы.

В режиме сервера приложение ожидает TCP-подключений к порту `PORT` и
выполняет команды, отправляемый клиентами. Синтаксис командной строки:

```bash
calc PORT
```

Запуск в режиме клиента приложение подключается по TCP-соединению к порту `PORT` сервера с адресом `ADDRESS`.
Синтаксис командной строки.

```bash
calc ADDRESS PORT
```

В режиме клиента пользователь может отправлять на сервер команды двух видов:

- сложение целых чисел.
- вычитание целых чисел.

Числа могут быть положительными, отрицательными или равны нулю.

Синтаксис команды сложения:

```txt
+ число1 число2 ... числоN
```

В ответ на эту команду сервер должен вычислить сумму `число1 + число2 + ... + числоN` и отправить её клиенту.

Синтаксис команды вычитания:

```txt
- число1 число2 ... числоN
```

В ответ на эту команду сервер должен вычислить разность `число1 - число2 - ... - числоN` и отправить её клиенту.

#### Требования

- Между числами допускается произвольное количество пробелов.
- В случае некорректных данных, например, если при разборе очередного числа возникла ошибка
  или не передано ни одного числа, сервер должен вернуть ошибку.
- Получив ответ от сервера, клиент должен вывести результат (число или ошибка) и продолжить ввод.
- При отключении клиента сервер должен продолжать работу с остальными клиентами.
- Если соединение с сервером было потеряно (например, из-за перезапуска сервера),
  клиент должен сделать несколько попыток переподключиться к серверу при отправке очередной команды.
  При исчерпании попыток, клиент должен вывести сообщение об ошибке и завершить свою работу.

#### Подсказки

Выберите протокол прикладного уровня для взаимодействия между клиентом и сервером на своё усмотрение.

#### Частые ошибки

- **Предположение, что TCP передаёт сообщения целиком.**
  TCP — потоковый протокол. Один вызов `recv` может вернуть часть команды, несколько команд или вообще пустую строку.
  Границы команд необходимо определять самостоятельно (например, по символу конца строки).
- **Отсутствие поддержки нескольких клиентов.**
  Сервер не должен завершать работу или блокироваться при подключении/отключении одного клиента.
- **Некорректная обработка ошибок ввода.**
  Команды без аргументов, с нецелыми числами,
  лишними символами или переполнением числового типа должны обрабатываться как ошибки.
- **Отсутствие чёткого формата ответа сервера.**
  Клиент должен однозначно понимать, является ли ответ успешным результатом или сообщением об ошибке.

### Задание 2 — Доска для рисования — 150 баллов

Ознакомьтесь с библиотекой [Boost.Asio](https://www.boost.org/doc/libs/1_86_0/doc/html/boost_asio.html).
Используйте её для работы с сокетами в этом задании.

Разработайте GUI-приложение, эмулирующее работу доски для рисования.

Приложение может работать как в режиме сервера либо в режиме клиента.
Запуск в режиме сервера:

```bash
whiteboard PORT
```

Запустив приложение в режиме сервера, пользователь может рисовать
на поверхности окна линии при помощи мыши.
При этом приложение должно быть способно принимать подключения
к указанному порту и отправлять клиентам информацию о рисуемых линиях.

Запуск приложения в режиме клиента:

```bash
whiteboard ADDRESS PORT
```

В этом режиме приложение подключается к указанному серверу и отображает
все линии, которые были нарисованы на сервере после момента подключения.

К серверу может динамически подключаться произвольное количество клиентов.
При закрытии приложения-клиента сервер должен продолжать работу
и отправлять команды рисования оставшимся клиентам.

![Клиент и сервер, запущенный на одном компьютере](images/whiteboard.png)
*Клиент (справа) повторяет рисунок, который нарисован на сервере (слева).*

При изменении размеров окна приложения (не важно, клиентского или серверного), изображение в окне пропадать не должно.
Область изображения можно ограничить некоторыми разумными  размерами (например 800*600 пикселей).

#### Подсказки

- Линию можно представлять как набор отрезков между соседними позициями курсора при зажатой кнопке мыши.

#### Бонус за возможность клиентов также управлять рисованием — 50 баллов

Пользователи, запустившие приложение в режиме клиента также должны быть
способны рисовать в своём окне при помощи мыши.
Другие пользователи, включая пользователя, запустившего сервер, должны
видеть то, что рисует пользователь.

#### Бонус за возможность смены цвета рисования — 20 баллов

Пользователь должен иметь возможность изменить цвет рисования, используя команду меню.
Если в вашей программе клиенты также могут рисовать на доске,
то каждый из них выбирает только цвет только собственного маркера.

Внимание, организуйте такой способ обмена данными между приложениями,
чтобы порядок отрисовки линий в них был одинаковым.

Например, если 3 пользователя начали рисовать линии разного цвета,
все они должны видеть линии в одном и том же порядке.

#### Частые ошибки

- **Рисование напрямую на экран без хранения модели изображения.**
  Если линии не сохраняются в памяти приложения,
  изображение пропадёт при перерисовке окна (например, при изменении его размеров).
- **Обновление GUI из сетевого потока.**
  Сетевой код и графический интерфейс должны быть разделены.
  Изменения состояния GUI следует выполнять только из основного потока приложения.
- **Отсутствие синхронизации при работе с несколькими клиентами.**
  Сервер должен корректно обрабатывать одновременные подключения и отключения клиентов.
- **Несогласованный порядок отрисовки линий.**
  Если события рисования обрабатываются в разном порядке на разных клиентах, изображение будет отличаться.
  Порядок отрисовки должен определяться единым образом (например, сервером).
- **Отправка слишком “крупных” событий.**
  Передача всей линии целиком вместо последовательности отрезков
  может приводить к заметным задержкам и “рваному” отображению рисунка.

### Задание №3 — Поисковая система — 200 баллов

На основе [поисковой системы из 4 лабораторной работы](../04/README.md) разработайте
веб-сервер, позволяющий добавлять в индекс веб-страницы документы и искать по их содержимому.
Бэкенд сервера должен быть разработан на C++ и использовать библиотеку Boost.Asio и Boost.Beast.

Примерный интерфейс представлен ниже. Стек для разработки фронтенда можете использовать любой.
Вы можете организовать приложение как в виде SPA-приложения, которое
отправляет запросы на бэкенд и рендерит результат, так и в виде
многостраниченого приложения, где контент рендерится на сервере.

![image](images/search-server.png)

Пользователь должен иметь возможность ввести свой запрос в текстовое поле.

В ответ на этот запрос выводится страница с результатами поиска.
На ней отображаются названия документов.
При клике по названию выполняется открытие.
Результаты должны быть отсортированы по релевантности:
сначала выводятся документы, которые лучше всего соответствуют запросу пользователя в соответствии с метрикой TF-IDF.

Должна иметься возможность добавить документ в поисковую систему при помощи формы добавления документа.

![alt text](images/add-document.png)

Если указан URL ранее проиндексированной страницы, то старое содержимое должно замениться новым.

Добавление, поиск и замена документов могут выполняться многими пользователями одновременно.
Предусмотрите подходящие средства синхронизации, чтобы не было состояния гонки.
Достаточно обеспечить потокобезопасность на уровне хранилища документов и индекса
(например, std::shared_mutex: shared для поиска, unique для добавления/замены).

В базовой части задания допускается хранить проиндексированные документы
только в ОЗУ и после перезапуска сервера начинать с чистого листа.

#### Сохранение документов в постоянное хранилище — 50 баллов

Предусмотрите возможность сохранения проиндексированной базы данных
в персистентное (постоянное) хранилище, чтобы после перезапуска сервера
восстанавливалась информация о ранее проиндексированных документах.

Вы можете использовать для персистентного хранения данных либо файловую систему,
либо базу данных. Вне зависимости от выбранного способа хранения полнотекстовый поиск
должен выполняться средствами вашего приложения.

#### Бонус за автоматическое наполнение поисковой системы —80 баллов

Сервер должен предоставлять API для добавления документа в индекс и проверки наличия документа в индексе (по URL-у).

Разработайте скрипт (на любом языке программирования), который бы
сканировал содержимое веб-страниц, начиная с некоторой стартовой страницы,
извлекал из них заголовок и текст, очищенный от HTML-тегов.
Извлечённый документ должен добавляться в поисковую систему с помощью API.

Также скрипт должен парсить гиперссылки на странице (тег `<A>`), извлекать из них URL
и повторять процесс индексирования страниц на этом же домене.

Добавление веб страниц через API также может выполняться параллельно,например, несколькими одновременно запущенными скриптами.
Используйте необходимые средства, чтобы не было состояния гонки.

#### Бонус за поддержку постраничной выдачи результатов — 20 баллов

Реализуйте постраничную отдачу результатов поиска.
На каждой странице выводится не более 10 ссылок на документы, а внизу —
ссылки на другие страницы с результатами поиска.

Максимум — 10 страниц.

#### Бонус за вывод фрагмента документа, содержащего искомые слова — 50 баллов

Помимо названия документа должен вывестись фрагмент текста документа,
в котором содержатся найденные слова.
Достаточно вывести один фрагмент вокруг первого (или наиболее плотного) вхождения слов запроса;
если окна перекрываются — объединяйте. Ограничьте итог 30 словами.

Например, имеется документ с таким тестом:

> C++ широко используется для разработки программного обеспечения,
являясь одним из самых популярных языков программирования.
Область его применения включает создание операционных систем,
разнообразных прикладных программ, драйверов устройств,
приложений для встраиваемых систем, высокопроизводительных серверов,
а также компьютерных игр.
Существует множество реализаций языка C++, как бесплатных,
так и коммерческих и для различных платформ.
Например, на платформе x86 это GCC, Clang, Visual C++, Intel C++ Compiler,
Embarcadero (Borland) C++ Builder и другие.
C++ оказал огромное влияние на другие языки программирования,
в первую очередь на Java и C#.

В результатах поиска по запросу "С++ для разработки игр" фрагмент
этого документа должен выводиться так:

> **C++** широко используется **для разработки** программного обеспечения,
являясь … драйверов устройств, приложений **для** встраиваемых систем,
высокопроизводительных … а также компьютерных **игр**.
множество реализаций языка **C++**, как бесплатных,

#### Бонус за возможность выполнить graceful shutdown  — 10 баллов

При SIGINT/SIGTERM сервер должен перестать принимать новые соединения,
корректно закрыть acceptor/сокеты и завершить обработку активных запросов 
(или корректно отменить их), не оставляя подвисших потоков.

#### Частые ошибки

- **Отсутствие потокобезопасности при одновременном поиске и добавлении документов.**
  Поиск, добавление и замена документов могут выполняться параллельно,
  поэтому доступ к индексу и хранилищу документов должен быть синхронизирован.
- **Нестабильная или некорректная сортировка результатов поиска.**
  Результаты должны сортироваться по релевантности (TF-IDF) и давать предсказуемый порядок при одинаковых запросах.
- **Неполная или некорректная токенизация текста.**
  Ошибки при разбиении текста на слова, игнорирование регистра или знаков препинания
  приводят к неожиданным результатам поиска.
- **Отсутствие обработки повторного добавления документа.**
  Если документ с таким URL уже существует, его содержимое должно быть корректно заменено.
- **Блокирующая обработка HTTP-запросов.**
  Длительные операции (например, добавление документов или работа с диском) не должны блокировать обработку других запросов.
- **Некорректная реализация graceful shutdown.**
  Немедленный вызов `exit` при получении сигнала
  без корректного закрытия сокетов и завершения активных операций считается ошибкой.
- **Отсутствие дедупликации при автоматическом наполнении.**
  При индексировании веб-страниц необходимо учитывать уже проиндексированные URL, 
  иначе возможны дубликаты и зацикливание обхода.
- **Некорректный вывод фрагментов текста.**
  Фрагмент должен быть ограничен по длине, содержать искомые слова и корректно выделять их форматированием.
